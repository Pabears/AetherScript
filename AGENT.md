# AetherScript 敏捷重构工作流

本文档记录了在对 AetherScript (aesc) 项目进行大规模面向服务架构 (SOA) 重构时，我们探索并验证的一套敏捷、安全、可追溯的最佳实践工作流。

## 核心原则

- **渐进式推进**: 绝不一次性进行大规模、破坏性的修改。将大型重构任务分解为一系列独立的、可验证的微小步骤。
- **安全第一**: 在每一步修改前后，都通过测试来验证系统的行为是否与预期一致，确保不引入新的 bug。
- **先结构，后实现**: 首先搭建起新的架构骨架，然后再将旧的逻辑迁移到新骨架中。
- **测试驱动迁移**: 在进行实质性的逻辑修改前，先为现有功能编写测试用例，用测试来“锁定”和“保护”现有行为。
- **人在循环**: 每个文件重构完成后，需要用户确认，然后再进行下一个文件的小迭代。



## 标准重构流程

整个流程分为五个主要阶段，确保每一步都建立在坚实、已验证的基础之上。

### 阶段一：架构设计与骨架搭建

1.  **宏观规划**: 定义清晰的目标架构（例如，SOA），并将整个重构过程分解为几个逻辑清晰的大阶段（如：服务化改造、集成、测试、清理等）。
2.  **服务识别**: 从现有代码中识别出独立的业务逻辑单元，定义出需要创建的服务列表。
3.  **骨架创建 (一次一个服务)**:
    -   **定义接口**: 在 `src/services` 目录下，为单个服务创建其抽象类或接口。这个文件定义了该服务的“契约”。
    -   **创建实现**: 在 `src/generated` 目录下，创建该服务的具体实现类 (`...ServiceImpl.ts`)。
    -   **关键：实现层作为封装器 (Wrapper)**: 在这一步，实现类**不包含任何逻辑**，它仅仅是作为一个“封装器”或“外观”，其内部实现是直接调用旧代码中的原始函数。这使得我们可以在不改变任何行为的前提下，快速搭建起全新的架构骨架。
    - **人在循环**: 每个文件重构完成后，需要用户确认，然后再进行下一个文件的小迭代。
4.  **循环**: 对所有已识别的服务，重复第 3 步。

### 阶段二：集成与初步验证

1.  **创建依赖注入 (DI) 容器**: 在 `src/generated` 目录下创建一个 `container.ts` 文件。该容器负责实例化所有在前一阶段创建的服务实现类。
2.  **更新入口点**: 修改应用的唯一入口点（例如 `src/cli/index.ts`），使其不再调用旧的函数，而是从 DI 容器中获取服务实例，并调用服务上的方法。
3.  **高层验证**: 运行一次高级别的验证命令（例如 `bun run build`, `bun run src/index.ts --help`），确保在新的“接线”方式下，应用可以被成功构建和启动。

### 阶段三：建立测试安全网

这是整个流程中最关键的一步，它为后续的逻辑迁移提供了信心和保障。

1.  **确定测试策略**: 识别项目所用的测试框架（例如 `bun:test`），并为服务测试规划好目录结构（例如 `aesc/tests/services`）。
2.  **编写测试 (一次一个服务)**:
    -   为每个服务创建一个对应的测试文件。
    -   测试应直接面向服务的公共接口 (`Service` 而非 `ServiceImpl`)。
    -   **关键：锁定当前行为**: 测试的目标是验证服务**当前**的行为，无论其行为是否“正确”。如果在测试中发现了预期之外的行为（例如，一个函数返回了小写的字符串而不是预期的驼峰式），**应该修改测试的断言以匹配这个实际行为**，而不是去修复代码。这会将现有行为“锁定”下来。
    -   根据服务的性质选择合适的测试方法（单元测试、集成测试等），在必要时使用 `spyOn` 或受控的测试环境，但应尽可能地测试真实逻辑，避免过度 mock。
3.  **运行与迭代**: 每完成一个服务的测试文件，就立即运行它，修复测试代码中的问题，直到它 100% 通过。
4.  **人在循环**: 每个文件重构完成后，需要用户确认，然后再进行下一个文件的小迭代。

### 阶段四：核心逻辑迁移

在测试安全网的保护下，现在可以开始进行最核心的、侵入式的代码修改。

1.  **迁移实现 (一次一个服务)**:
    -   打开一个服务的实现文件 (`...ServiceImpl.ts`)。
    -   将其中对旧代码的调用，替换为旧代码文件中的**实际业务逻辑**。
    -   如果该服务依赖其他服务，应通过其构造函数中已注入的其他服务实例 (`this.otherService.doWork()`) 来调用，而不是直接实例化或调用旧函数。
2.  **即时验证**: 每完成一个服务的逻辑迁移，**立即重新运行其对应的测试文件**。测试应该依然 100% 通过，这证明了我们的迁移是成功的，且没有改变任何外部可见的行为。
3.  **人在循环**: 每个文件重构完成后，需要用户确认，然后再进行下一个文件的小迭代。

### 阶段五：最终清理与验证

1.  **清理**: 当所有服务的逻辑都已迁移完毕，并且所有测试都通过后，现在可以安全地删除所有不再被引用的旧代码目录和文件（例如 `src/core`, `src/utils` 等）。
2.  **终极验证**: 在删除了所有旧代码后，再次执行一次完整的、全局的验证流程：
    -   `bun install`
    -   `bun test` (运行所有测试)
    -   `bun run build`
    -   `bun run src/index.ts --help`

完成以上所有步骤后，整个重构项目便宣告成功。我们获得了一个架构清晰、完全解耦、经过全面测试的健壮应用。
